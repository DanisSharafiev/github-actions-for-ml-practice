name: Very advanced ML Workflow


on:
  push:
    branches:
      - main
    paths:
      - 'part3/train.py'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  run-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Docker build and Test
        run: |
          cd part3
          docker compose up --build -d

      - name: Test FastAPI Health Endpoint
        run: |
          for i in {1..5}; do
            if curl -s http://localhost:8000/health | grep -q healthy; then
              echo "FastAPI is up!"
              break
            fi
            sleep 1
          done

      - name: Test Prediction Endpoint
        run: |
          RESPONSE=$(curl -s -X 'POST' 'http://localhost:8000/predict' \
            -H 'Content-Type: application/json' \
            -d '{
              "sepal_length": 5.1,
              "sepal_width": 3.5,
              "petal_length": 1.4,
              "petal_width": 0.2
            }')
          
          echo "Prediction response: $RESPONSE"

      
  generate-report:
    needs: run-tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4

      - name: Generate Report
        run: | 
          precision=$(jq '.precision' part3/models/best/metadata.json)
          recall=$(jq '.recall' part3/models/best/metadata.json)
          f1=$(jq '.f1' part3/models/best/metadata.json)
          model_type=$(jq -r '.model_filename' part3/models/best/metadata.json | sed -E 's/model_(.*)\.joblib/\1/')

          mkdir -p part3/reports
          report_path=part3/reports/best_model_report.md

          echo "# Best Model Report" > "$report_path"
          echo "" >> "$report_path"
          echo "## Model Info" >> "$report_path"
          echo "" >> "$report_path"
          echo "- **Model Type**: $model_type" >> "$report_path"

          echo "- **Parameters**:" >> "$report_path"
          jq -r '.params | to_entries[] | "  - \(.key): \(.value)"' part2/models/best/metadata.json >> "$report_path"
          echo "" >> "$report_path"

          echo "## Metrics" >> "$report_path"
          echo "" >> "$report_path"
          echo "| Metric    | Value |" >> "$report_path"
          echo "|-----------|-------|" >> "$report_path"
          echo "| Precision | $precision |" >> "$report_path"
          echo "| Recall    | $recall |" >> "$report_path"
          echo "| F1 Score  | $f1 |" >> "$report_path"
          echo "" >> "$report_path"

          echo "## Images" >> "$report_path"
          echo "" >> "$report_path"
          for img in part3/models/best/*.png; do
            rel_path=$(realpath --relative-to=reports "$img")
            echo "![Image]($rel_path)" >> "$report_path"
          done

      - name: Commit and push changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          git add part3/reports/best_model_report.md
          git commit -m "Update model report from GitHub Actions" || echo "No changes to commit"
          git push https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git HEAD:${{ github.ref_name }}
