name: Very advanced ML Workflow


on:
  push:
    branches:
      - main
    paths:
      - 'part3/train.py'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  run-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Docker build and Test
        run: |
          cd part3
          docker compose up --build -d

      - name: Test FastAPI Health Endpoint
        run: |
          echo "Starting health check..."
          
          # Check if container is running
          echo "Checking running containers:"
          docker ps
          
          # Check container logs
          echo "Container logs:"
          docker compose -f part3/docker-compose.yml logs
          
          # Wait for service to be ready
          for i in {1..30}; do
            echo "Attempt $i/30: Checking health endpoint..."
            
            # Check if port is listening
            if nc -z localhost 8000; then
              echo "Port 8000 is open"
              
              # Try health check
              HEALTH_RESPONSE=$(curl -s -w "HTTP_CODE:%{http_code}" http://localhost:8000/health || echo "CURL_FAILED")
              echo "Health response: $HEALTH_RESPONSE"
              
              if echo "$HEALTH_RESPONSE" | grep -q "healthy"; then
                echo "FastAPI is up and healthy!"
                break
              else
                echo "Service responded but not healthy yet"
              fi
            else
              echo "Port 8000 is not open yet"
            fi
            
            if [ $i -eq 30 ]; then
              echo "Health check failed after 30 attempts"
              echo "Final container status:"
              docker ps -a
              echo "Final logs:"
              docker compose -f part3/docker-compose.yml logs
              exit 1
            fi
            
            sleep 2
          done

      - name: Test Prediction Endpoint
        run: |
          RESPONSE=$(curl -s -X 'POST' 'http://localhost:8000/predict' \
            -H 'Content-Type: application/json' \
            -d '{
              "sepal_length": 5.1,
              "sepal_width": 3.5,
              "petal_length": 1.4,
              "petal_width": 0.2
            }')
          
          echo "Prediction response: $RESPONSE"

      - name: Commit and push changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          git add part3/reports/best_model_report.md
          git commit -m "Update model report from GitHub Actions" || echo "No changes to commit"
          git push https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git HEAD:${{ github.ref_name }}
